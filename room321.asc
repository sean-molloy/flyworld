// room script file
int currentPhoneme = 0;
int blinkDuration  = 8;
int blinkCounter = 0;
bool blinkingAllowed = false;
int dryEyes = 40;
function llBlink()
{
  if(blinkingAllowed)
  {
    blinkCounter++;
    if(blinkCounter == dryEyes)
    {
      
      oLandBlink.Visible = true;
    } else if (blinkCounter == dryEyes + blinkDuration)
    {
      oLandBlink.Visible = false;
      dryEyes = 30 + Random(60);
      blinkCounter = 0;     
    }
  }
}


bool abiBlinkingAllowed = true;
int counter = 0;
int abiDryEyes = 50;
function abiBlink()
{
  if(abiBlinkingAllowed)
  {
  
  counter++;
  if(counter == abiDryEyes)
  {
    oAbiBlink.Visible = true;
    
  } else if (counter == abiDryEyes + 8)
  {
    oAbiBlink.Visible = false;
    abiDryEyes = 50 + Random(100);
    counter = 0;
  }
  }
}


bool paulBlinkingAllowed = true;
int paulCounter = 0;
int paulDryEyes = 50;
function paulBlink()
{
  if(paulBlinkingAllowed)
  {
  
  paulCounter++;
  if(paulCounter == paulDryEyes)
  {
    oPaulBlink.Visible = true;
    
  } else if (paulCounter == paulDryEyes + 8)
  {
    oPaulBlink.Visible = false;
    paulDryEyes = 70 + Random(100);
    paulCounter = 0;
  }
  }
}


function pointAtAbi()
{
  oPoint.SetView(224, 9, 0);
  oPoint.Visible = true;
  oPoint.Animate(9, 2, eOnce, eNoBlock, eForwards);
}

function stopLandBlink()
{
  blinkingAllowed = false;
 oLandBlink.Visible = false;
}

function landArmRaise()
{
  oArm.SetView(224, 3, 0);
  oArm.Visible = true;
  oArm.Animate(3, 1, eOnce, eNoBlock, eForwards);
}

function landArmLower()
{
 oArm.SetView(224, 5, 0);
    oArm.Animate(5, 1, eOnce, eNoBlock, eForwards);
  
}

function landHandChop()
{
  oArm.Animate(4, 1, eRepeat, eNoBlock, eForwards);
}
function paulSpeak(String paulSaid)
{
   cUPaulSideShot.SayAtSync(120, 100, 120, paulSaid);  
}


function room_Load()
{
  oShadow.Transparency = 90;
  oShock.SetView(229, 2, 0);
  oAngryABi.SetView(229, 3, 0);
  //cutSceneShot = 12;
  if(cutSceneShot == 25)
  {
  cLandLordSide.Loop = 0;
  } else if (cutSceneShot == 37)
  {
    cLandLordSide.Loop = 0;
      oEyeSHut.Visible = false;
  }else {
    cLandLordSide.Loop = 1;
    oEyeSHut.Visible = false;
  }
  if(cAbiCSide.Room != eCSR_hallSideShot)
  {
    cAbiCSide.ChangeRoom(eCSR_hallSideShot);
  }
}

function landLordTalk(String theString)
{    
  if(theString.Length > 12)
  {
      cLandLordSide.SayAtSync(140 , 20, 140 ,  theString);
  } else {
      cLandLordSide.SayAtSync(200 , 20,80,  theString);   
  }
 
  
}


function abiSpeak(String abiSays)
{
   cAbiCSide.SayAtSync(45, 23, 140, abiSays);
}

function shrug()
{
  oShrug.SetView(229, 4, 0);
  oShrug.Visible = true;
  oShrug.Animate(4, 2, eOnce, eNoBlock, eForwards);
}

function chuckle()
{
  oShrug.SetView(229, 7, 0);
  oShrug.Visible = true;
  oShrug.Animate(7, 3, eOnce, eNoBlock, eForwards);
}

function dontChuckle()
{
 // oShrug.Animate(7, 5, eOnce, eNoBlock, eBackwards);
}

function scream()
{
  oScream.SetView(229, 5, 0);
  oScream.Visible = true;
  oScream.Animate(5, 3, eOnce, eNoBlock, eForwards);
}
bool screaming = false;
function bigScream()
{
  if(oScream.Frame == 5 && !screaming)  
  {
    oScream.Animate(6, 3, eRepeat, eNoBlock, eForwards);
    screaming = true;
  }
}
function shock()
{
  oAbiBlink.Visible = false;
  abiBlinkingAllowed = false;
  oShock.Animate(2, 3, eOnce, eNoBlock, eForwards);
 
}

function angry()
{
  oAngryABi.Animate(3, 3, eOnce, eNoBlock, eForwards);
}
function shot25()
{

   landLordTalk("&7 Oh, righto.");
   
   oEyeSHut.Visible = false;
   Wait(1);

   cLandLordSide.LockView(224);
   cLandLordSide.Animate(0, 2, eOnce, eNoBlock, eForwards, 0);
   angry();
   abiSpeak("&41 What's this about?");
   cLandLordSide.UnlockView(eStopMoving);
   cLandLordSide.Loop = 1;
   landLordTalk("&8 Well uh,");
  
  Cutscenes.nextCutSceneShot();
}

function worryLandy()
{
    oLandBrow.Graphic = 3678;
    oLandBrow.Visible = true;
}

function shot30()
{
  blinkingAllowed = true;
  oAbiWOrry.Visible = true;
   abiSpeak("&42 Not the yacht!");
   oAbiWOrry.Visible = false;
   cAbiCSide.Loop = 1;
   //oAbiLookDown.Visible = true;
   WaitSeconds(0.1);
   oLandBrow.Visible = true;
   chuckle();
    abiSpeak("&43 How will you do all your human trafficking?");
    //oAbiLookDown.Visible = false;
    dontChuckle();
    
    landLordTalk("&15 No, no,");
    oLandBrow.Visible = false;
    cAbiCSide.Loop = 0;
    Cutscenes.nextCutSceneShot();
}

function shot32()
{
  blinkingAllowed = true;
  shock();
 
  abiSpeak("&44 Last time we saw him he...");
  shrug();
  WaitSeconds(0.5);
   scream();
  abiSpeak("&45 He...");
  stopLandBlink();
  
  cLandLordSide.LockView(224, eStopMoving);
  cLandLordSide.Animate(2, 2, eOnce, eNoBlock);
  paulSpeak("&23 He went through the weird door.");
  cLandLordSide.UnlockView(eStopMoving);
  cLandLordSide.Loop = 0;
  landLordTalk("&19 Ah yup, which one's the weird door?");
  Cutscenes.nextCutSceneShot();
}


function shot34()
{
  angry();
  abiSpeak("&46 We told you about the weird door ages ago.");
  abiSpeak("&47 You never fix anything!");
   worryLandy();
  landArmRaise();
  landLordTalk("&20 What people always forget, is that");
  landHandChop();
  oAbiLookDown.Visible = true;
 
  landLordTalk("&103 everything costs money.");
  oArm.StopAnimating();
  landArmLower();
  oAbiLookDown.Visible = false; // make abi look up on "money"
  abiSpeak("&48 Ugh!");
    
  //WaitSeconds(0.4);
  Cutscenes.nextCutSceneShot();
}

function shot37()
{
  landLordTalk("&24 Oh yeah?");

   Wait(1);
  cLandLordSide.LockView(224);
  cLandLordSide.Animate(0, 2, eOnce, eBlock, eForwards, 0);
  
  
  
  cLandLordSide.UnlockView(eStopMoving);

  cLandLordSide.Loop = 1;
 
  pointAtAbi();
  landLordTalk("&25 It might be easier if you paid the rent");
  Cutscenes.nextCutSceneShot();
  //landLordTalk("&26 directly to me.");
  //EndCutscene();
}

function room_AfterFadeIn()
{
  if(cutSceneShot == 25)
  {
    shot25();
  } else if (cutSceneShot == 30)
  {
    shot30();
  } else if (cutSceneShot == 32)
  {
    shot32();
  } else if (cutSceneShot == 34)
  {
    shot34();
   
  } else if (cutSceneShot == 37)
  {
    shot37();
  }
}

function makeShadow()
{
  if(oArm.Visible && oArm.View)
  {
  oShadow.SetView(224, oArm.Loop + 3, oArm.Frame);
  }
}

function repExWorry()
{
  if(currentPhoneme == 1)
  {
    worryLandy();
    currentPhoneme = 0;
  }
}

function getPhonemeStressNum()
{ 
  if(TotalLipSync.GetCurrentPhoneme()!= null)
  {
    String theString = TotalLipSync.GetCurrentPhoneme();
    if(theString.EndsWith("1"))
    {
      currentPhoneme = 1;
    } else if (theString.EndsWith("2"))
    {
      currentPhoneme = 2;
    } else if(theString.EndsWith("3"))
    {
      currentPhoneme = 3;
    } else if(theString.EndsWith("4"))
    {
      currentPhoneme = 4;
    }else if(theString.EndsWith("5"))
    {
      currentPhoneme = 5;
    } else if (theString.EndsWith("6"))
    {
      currentPhoneme = 6;
    } else
    {
      currentPhoneme = 0;
    }
  } else {
    currentPhoneme = 0;
  }
}

function late_repeatedly_execute_always()
{
  getPhonemeStressNum();
  llBlink();
  abiBlink();
  paulBlink();
  bigScream();
  makeShadow();
  repExWorry();
}