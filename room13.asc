// room script file
int whenIsSunset = TIME_EVENING;
int whenIsNight = TIME_NIGHT;

float timeToAsk = 2.0;
Overlay* speechBubble; 


function clearSpeechBubble()
{
  if(speechBubble != null)
  {    
    if(speechBubble.Valid)
    {
      speechBubble.Remove();  
    }
  }
}

function placeDistance(int atX)
{
  oDistance.X = atX; // - 60;
  oSunset.X = atX; // - 60;
  oNight.X = atX;
}

function findCameraPositionAfterCharacterChange()
{ 
  characterChange = false;
  switch(Find.findPlayer())
  {
    case 1:
      Game.Camera.SetAt(306, 0);
      placeDistance(306);
      
    break;
    case 2:
      Game.Camera.SetAt(524, 0);
      placeDistance(524);
      
    break;
    case 3:
      Game.Camera.SetAt(707, 0);
      placeDistance(707);
      
    break;
    default:
      Game.Camera.SetAt(306, 0);
      placeDistance(306);
      
    break;        
  }
}

function findCameraPosition()
{
  if(player.PreviousRoom == eRooms_Omni_CorridorLeft)
  {
    Game.Camera.SetAt(0, 0);
    placeDistance(0);
    
  } else if (player.PreviousRoom == eRooms_Omni_CorridorRight)
  {
    Game.Camera.SetAt(925, 0);
    placeDistance(925);
    
  } else {
    findCameraPositionAfterCharacterChange();
    
  }
}

function setupComp(Object* theComp)
{
  theComp.Baseline = 122;
  theComp.SetView(111, Random(1), Random(10));
  theComp.Animate(Random(1), 4, eRepeat, eNoBlock, eForwards);
}


function setupComps()
{
    setupComp(comp1);
    setupComp(comp2);
    setupComp(comp3);
    setupComp(comp4);
    setupComp(comp5);
    setupComp(comp6);
    setupComp(comp7);
    setupComp(comp8);
    setupComp(comp9);
}

function turnOnLightsLoad()
{
  if(Time.isItBetweenTheseHours(6, 21))
  {
    SetBackgroundFrame(0);
  } else {
    SetBackgroundFrame(1);
  }
}

function turnOnLightsRepExec()
{
  if(Time.atTimeOfDay(6, 0))
  {
    SetBackgroundFrame(0);
  }
  if(Time.atTimeOfDay(21, 0))
  {
    SetBackgroundFrame(1);
  }
}

function prevRoomConditions()
{
  switch(player.PreviousRoom)
  {
    case eRooms_Omni_CorridorLeft:
     // cJohn.setEntryTimer(20);
    break;
    case eRooms_Omni_CorridorRight:
    
    break;    
  }
}


function parallaxDistance(int toX,  int fromX)
{
  /*
  int parallaxOffset = 30;
  int difference = toX - fromX;
  int distanceOldX = oDistance.X;
  int theDestination;
  
  if(toX < fromX) //camera going left
  {
    theDestination = distanceOldX + difference + parallaxOffset;
  } else { //camera going right
    theDestination = distanceOldX + difference - parallaxOffset;
  }*/
  int theDestination = toX;
  oSunset.TweenX(1.0, theDestination, eEaseInOutSineTween, eNoBlockTween);
  oDistance.TweenX(1.0, theDestination, eEaseInOutSineTween, eNoBlockTween);
  oNight.TweenX(1.0, theDestination, eEaseInOutSineTween, eNoBlockTween);
}

function scrollTheRoom(int toX)
{
  SetTimerWithSeconds(16, 1.5);
  clearSpeechBubble();
  int fromX = Game.Camera.X;
  Game.Camera.TweenX(1.0, toX, eEaseInOutSineTween, eNoBlockTween);
  parallaxDistance(toX, fromX);
}




function room_AfterFadeIn()
{
  if(player.PreviousRoom == eRooms_Omni_CorridorLeft)
  {
    
    scrollTheRoom(306);
    
    
    player.Walk(1009, player.y, eNoBlock);
  } else if (player.PreviousRoom == eRooms_Omni_CorridorRight)
  {
    scrollTheRoom(707);
      
    player.Walk(326, player.y, eNoBlock);
  }
  aMuffledVoices.Play(eAudioPriorityHigh, eRepeat);
}

/****************Scrolling Stuff******************************************************************/

int wasHere = 0;

function region2_WalksOff()
{
  wasHere = 2;
}

function region2_WalksOnto()
{
  if(wasHere == 3)
  {
    scrollTheRoom(306);
       

    wasHere = 0;
  }
}

function region3_WalksOff()
{
  wasHere = 3;
}

function region3_WalksOnto()
{
  if(wasHere == 2)
  {
    scrollTheRoom(524);
     
    wasHere = 0;
  }
}

function region4_WalksOff()
{
  wasHere = 4;
}

function region4_WalksOnto()
{
  if(wasHere == 5)
  {
    
    scrollTheRoom(524);
    
    wasHere = 0;
  }  
}

function region5_WalksOff()
{
  wasHere = 5;
}

function region5_WalksOnto()
{
  if(wasHere == 4)
  {
    scrollTheRoom(707);
    
    wasHere = 0;
  }
}

/******************Change Rooms***********************************************************************/


function region1_WalksOnto()
{
  player.ChangeRoom(eRooms_Omni_CorridorLeft, player.x + 250, player.y);
}

function region6_WalksOnto()
{
  player.ChangeRoom(eRooms_Omni_CorridorRight, player.x - 707, player.y);
}

/**************************INTERACTION ***********************************************************/

function hHall2_AnyClick()
{

switch (verbUsed)
{
  case 0: //walk

    player.Walk(1030, 174);
  break;
  case 1://look
    player.FaceDirection(eDirectionRight);
    lookAbiPaul("More hallway through there.", 
                "This place is endless!");
  break;
  case 2://use
    Canned.noUsing();
  break;
  case 3://talk
    Canned.noTalking();
  break;
  case 4://move
    Canned.noMoving();
  break;
  case 5://fourletters
    Canned.fuckAnyone();
  break;
  case 6://take
    Canned.cantTake();
  break;
  case 7://inv
    Canned.wontWork();
  break;
}
verbUsed = 0;

}

function hHall1_AnyClick()
{

switch (verbUsed)
{
  case 0: //walk

    player.Walk(322, 171);
  break;
  case 1://look
    player.FaceDirection(eDirectionLeft);
    lookAbiPaul("More hallway through there.", 
                "This place is endless!");
  break;
  case 2://use
    Canned.noUsing();
  break;
  case 3://talk
    Canned.noTalking();
  break;
  case 4://move
    Canned.noMoving();
  break;
  case 5://fourletters
    Canned.fuckAnyone();
  break;
  case 6://take
    Canned.cantTake();
  break;
  case 7://inv
    Canned.wontWork();
  break;
}
verbUsed = 0;

}

function computerInteraction(Object* theComp)
{
  int x = theComp.GetProperty("XX");
  int y = theComp.GetProperty("YY");
  String toSay;

  switch (verbUsed)
  {
    case 0: //walk
      walkToAndFace(x, y, eDirectionUp, x + 10, y + 10);    
    break;
    case 1://look
      player.FaceLocation(x, y - 10, eBlock);
      
      if(IsPlayerAbi)
      {
        toSay = String.Format("It's %s computer.", theComp.GetTextProperty("occupant"));
      } else {
        toSay = "I dunno, someone's computer.";
      }
      
      player.Say(toSay);
    break;
    case 2://use
      Canned.noUsing();
    break;
    case 3://talk
      Canned.noTalking();
    break;
    case 4://move
      Canned.noMoving();
    break;
    case 5://fourletters
      Canned.fuckAnyone();
    break;
    case 6://take
      Canned.cantTake();
    break;
    case 7://inv
      Canned.wontWork();
    break;
  }
  verbUsed = 0;
  
  
}

function comp1_AnyClick(){  computerInteraction(comp1); }
function comp2_AnyClick(){  computerInteraction(comp2); }
function comp3_AnyClick(){  computerInteraction(comp3); }
function comp4_AnyClick(){  computerInteraction(comp4); }
function comp5_AnyClick(){  computerInteraction(comp5); }
function comp6_AnyClick(){  computerInteraction(comp6); }
function comp7_AnyClick(){  computerInteraction(comp7); }
function comp9_AnyClick(){  computerInteraction(comp9); }
function comp8_AnyClick(){  computerInteraction(comp8); }

/*****************************Moving NPCS*****************************************************/

int computerPosition[36];

function initCompPos()
{
  //1
  computerPosition[0] = 427;
  computerPosition[1] = 124;
  //2
  computerPosition[2] = 904;
  computerPosition[3] = 128;
  //3
  computerPosition[4] = 521;
  computerPosition[5] = 99;
  //4
  computerPosition[6] = 1;
  computerPosition[7] = 1;
  //5
  computerPosition[8] = 1;
  computerPosition[9] = 1;
  //6
  computerPosition[10] = 1;
  computerPosition[11] = 1;
  //7
  computerPosition[12] = 1;
  computerPosition[13] = 1;
  //8
  computerPosition[14] = 1;
  computerPosition[15] = 1;
  //9
  computerPosition[16] = 1;
  computerPosition[17] = 1;
  //10
  computerPosition[18] = 1;
  computerPosition[19] = 1;
  //11
  computerPosition[20] = 1;
  computerPosition[21] = 1;
  //12
  computerPosition[22] = 1;
  computerPosition[23] = 1;
  //13
  computerPosition[24] = 1;
  computerPosition[25] = 1;
  //14
  computerPosition[26] = 1;
  computerPosition[27] = 1;
  //15
  computerPosition[28] = 1;
  computerPosition[29] = 1;
  //16
  computerPosition[30] = 1;
  computerPosition[31] = 1;
  //17
  computerPosition[32] = 1;
  computerPosition[33] = 1;
  //18
  computerPosition[34] = 1;
  computerPosition[35] = 1;  
}

int findX(this Character*)
{
  int charPos = this.ID - 8;
  return computerPosition[charPos];
}

int findY(this Character*)
{
  int charPos = this.ID - 8 + 1;
  return computerPosition[charPos];
}

function sendCharHome()
{
  if(Time.atTimeOfDay(17, 01))
  {    
    cBob.SetProperty("strolling",true);
  }
  
  if(Time.atTimeOfDay(17, 07))
  {
    cFred.SetProperty("strolling",true);
  }
  
  if(Time.atTimeOfDay(17, 15))
  {
    cSally.SetProperty("strolling",true);
  }
}

function moveStaff(Character* theChar)
{
  if(theChar.Room == eRooms_Omni_CallCentre)
  {
    switch(theChar.SCABS())
    {
      case 0:
        if(theChar.Room == eRooms_Omni_CallCentre)
        {
          if(theChar.GetProperty("strolling"))
          {
            if(Time.hasThisHourPassed(12))
            {
              theChar.SCABS(10);
            } else {
              theChar.SCABS(50);
            }
          }
        }      
      break;
      ////////////////////////////////////////////
      case 10: //going home
        //animate getting up from computer
        theChar.ChangeView(theChar.GetProperty("normalWalkView"));
        theChar.SCABS(1);
      break;
      case 11:
        if(theChar.y < 101)
        {
          theChar.SCABS(15);
        } else {
          theChar.SCABS(30);
        }
      break;
      ////////////////////////////////////////////
      case 15: //top row
        theChar.SCABSwalk(theChar.x, 119, 1, eAnywhere);
      break;
      case 16:
        theChar.SCABSwalk(1009, 119);
      break;
      case 17:
        theChar.SCABSwalk(974, 175);
      break;
      case 18:
        if(!theChar.Moving && !theChar.isAt(1010, 177))
        {
          theChar.Walk(1010, 177);
        } else if (theChar.x > 993)
        {
          theChar.TweenTransparency(0.4, 100, eEaseInOutSineTween, eNoBlockTween);
          theChar.SCABS(1);
        }            
      break;
      case 19:
        if(!theChar.Moving && !theChar.x < 1018)
        {
          theChar.Walk(1030, 177, eNoBlock, eAnywhere);
        } else if (theChar.Transparency == 100)
        {
          theChar.SCABS(1);
        }
      break;
      case 20:
        theChar.ChangeRoom(eRooms_Omni_CorridorRight, theChar.x - 707, theChar.y);
        theChar.SCABS(0); 
      break;
      
      ////////////////////////////////////////////
      
      case 30: //staff in lower row
      //getting up animation
        theChar.SCABS(1);
      break;
      case 31:
        
        theChar.SCABSwalk(theChar.x, 177, 1, eAnywhere);
      break;
      case 32:
        if(!theChar.Moving && !theChar.Transparency < 100)
        {
          theChar.Walk(1034, 177, eNoBlock, eAnywhere);
        } else if(theChar.Transparency == 0 && theChar.x > 985)
        {
          theChar.TweenTransparency(0.5, 100, eEaseInOutSineTween, eNoBlockTween);
          theChar.SCABS(1);
        }          
      break;
      case 33:
      
        if(!theChar.Moving && !theChar.Transparency < 100)
        {
          theChar.Walk(1044, 177, eNoBlock, eAnywhere);
        } else if(theChar.Transparency == 100)
        {
          theChar.SCABS(1);
        }
      break;
      case 34:
        theChar.ChangeRoom(eRooms_Omni_CorridorRight, theChar.x - 707, theChar.y); //sean
        theChar.SCABS(0);
      break;
      
      /////////////////////////////////////////////
      case 50: //arrival at office
      
      break;
    }      
  }
}

/*****************************Question Generator**********************************************/

int clauseOneType;
String makeFirstCause()
{
  String clause;
   
  switch(clauseOneType)
  {
    case 0:        
      switch(Random(1))
      {
        case 0:
        clause = "Have ";
        break;
        case 1:
        clause = "Haven't ";
        break;       
      }
    break;
    case 1:
      switch(Random(2))
      {
        case 0:
        clause = "When ";
        break;
        case 1:
        clause = "How ";
        break;   
        case 2:
        clause = "";
        break;
        
      }  
    break;
  }
  return clause;
}

String makeSecondClause()
{
  String clause;
  switch(clauseOneType)
  {
    case 0:
      switch(Random(1))
      {
        case 0:
        clause = "you ever experienced";
        break;
        case 1:
        clause = "you noticed";
        break; 
      }
    break;
    case 1:
    switch(Random(3))
      {
        case 0:
        clause = "was the last time";
        break;
        case 1:
        clause = "did you notice";
        break;    
        case 2:
        clause = "is it possible";
        break;
        case 3:
        clause = "many times";
        break;
      }
    break;
  }
  return clause;  
}
String makeThirdClause()
{
  String clause;
  switch(Random(8))
  {
    case 0:
    clause = "cats";
    break;
    case 1:
    clause = "windows";
    break;
    case 2:
    clause = "beans";
    break;
    case 3:
    clause = "fish";
    break;
    case 4:
    clause = "eyes";
    break;
    case 5:
    clause = "strangers";
    break;
    case 6:
    clause = "your parents";
    break;
    case 7:
    clause = "your best friends";
    break;
    case 8:
    clause = "your nanna and poppa";
    break;
  }
  return clause;
}

String makeForthClause()
{
  String clause;
  switch(clauseOneType)
  {
    case 0:
      switch(Random(5))
      {
        case 0:
        clause = "falling from";
        break;
        case 1:
        clause = "due to";
        break;    
        case 2:
        clause = "climbing into";
        break;
        case 3:
        clause = "cascading from";
        break;
        case 4:
        clause = "pouring over";
        break;
        case 5:
        clause = "eating all of";
        break;
      }
    break;
    case 1:
      switch(Random(3))
      {
        case 0:
        clause = "were seen inside";
        break;
        case 1:
        clause = "have been climbing into";
        break; 
        case 2:
        clause = "were talking about";
        break;
        case 3:
        clause = "going away to";
        break;
      }
    break;
  }
  return clause;  
}

String makeFifthClause()
{
  String clause;
  switch(Random(12))
  {
    case 0:
    clause = "the sky";
    break;
    case 1:
    clause = "your mouth";
    break;
    case 2:
    clause = "the post-box";
    break;
    case 3:
    clause = "the sound of my voice";
    break;
    case 4:
    clause = "the glowing vortex";
    break;
    case 5:
    clause = "the disappointing way your life has turned out";
    break;
    case 6:
    clause = "the excitement of a new day";
    break;
    case 7:
    clause = "a lonely heron";
    break;
    case 8:
    clause = "a vigorous pigeon";
    break;
    case 9:
    clause = "a lovely holiday";
    break;
    case 10:
    clause = "the tea kettle";
    break;
    case 11:
    clause = "the gallery";
    break;
    case 12:
    clause = "a really trendy party";
    break;
  }
  return clause;  
}
String makeSentence()
{
    clauseOneType = Random(1);

  String sentence =  String.Format("%s%s %s %s %s?", makeFirstCause(), makeSecondClause(), makeThirdClause(), 
  makeForthClause(), makeFifthClause());
  return HandyHelper.capitaliseSentence(sentence);
}

function hHotspot4_AnyClick()
{
  player.Say("%s",makeSentence());
}

function room_Leave()
{
  aMuffledVoices.Stop();
  //cJohn.prepRoomPos();
}
 
Character* talkingChar;
function chooseCharacter()
{
  
  switch(Find.findPlayer())
  {
    case 1:
      switch(Random(1))
      {
        case 0:        
          talkingChar = cBob;
        break;
        case 1:
          talkingChar = cFred;
          return true;
        break;
      }   
    break;    
    case 2:
      talkingChar = cBob;
    return true;
    break;
    case 3:
      talkingChar = cSally;
    return true;
    break;    
  }  
}
 
 
int askProcess = 0;

function askQuestion()
{    
  if(Time.isItBetweenTheseHours(9, 17))
  {
    switch(askProcess)
    {
      case 0:
        if(HandyHelper.roomDelay(timeToAsk))
        {      
          askProcess++;
        }
      break;
      case 1:
          chooseCharacter();          
          askProcess++;              
      break;
      case 2:
        talkingChar.LockView(112, eStopMoving);
        talkingChar.Animate(0, 2, eRepeat, eNoBlock, eForwards);
        Game.SpeechFont = eFontTinyText;
        speechBubble = talkingChar.SayBackground(makeSentence());      
        Game.SpeechFont = eFontSpeech; 
        timeToAsk = IntToFloat(8 + Random(8));
        askProcess++;
      break;
      case 3:    
          if(HandyHelper.roomDelay(3.4)) 
          {          
            talkingChar.UnlockView(eStopMoving);
            clearSpeechBubble();         
            askProcess = 0; 
          }                          
      break;
    }
  } else {
    clearSpeechBubble();
  }
}

function johnGoHome()
{
  John.johnDepart();
  John.johnArrive();
  if(cJohn.Room == eRooms_Omni_CallCentre)
  {
    if(!cJohn.Moving)
    {
      if(Time.hasThisHourPassed(12))
      {
        if(cJohn.x < Room.RightEdge)
        {
          cJohn.Walk(Room.RightEdge, cJohn.y);
          //cJohn.Transparency = 100;
          cJohn.TweenTransparency(0.5, 0,  eEaseInOutSineTween, eNoBlockTween);
        } else if ( cJohn.Transparency == 0)
        {
          cJohn.Walk(Room.RightEdge + 30, cJohn.y, eNoBlock, eAnywhere);
          
          cJohn.TweenTransparency(0.8, 100, eEaseInOutSineTween, eNoBlockTween);
          
        }
        if (cJohn.x > Room.RightEdge  && cJohn.Transparency > 90)
        {
         
          cJohn.ChangeRoom(eRooms_Omni_CorridorRight, 283 + cJohn.x - Room.RightEdge, cJohn.y);
          cJohn.Transparency = 0;
        }
      } else {
        if(cJohn.x > Room.LeftEdge)
        {
          cJohn.Walk(Room.LeftEdge, 171);
          if(cJohn.Transparency == 100)
          {
            cJohn.TweenTransparency(0.8, 0, eEaseInOutSineTween, eNoBlockTween);
          }          
        } else {
          cJohn.ChangeRoom(eRooms_Omni_CorridorLeft, cJohn.x + 250, 171);          
        }
        
      }
    }
  }
}

function room_RepExec()
{
  moveStaff(cBob);
  moveStaff(cFred);
  moveStaff(cSally);
  sendCharHome();
  
  
  Time.changeSky(oDistance, oSunset, oNight);  
  turnOnLightsRepExec();
  askQuestion();

  johnGoHome();
  cJohn.moveInOtherRoom(eRooms_Omni_CorridorLeft, 454, 
        eRooms_Omni_HR, 592, eRooms_Omni_CallCentre, 10, 10, 321, 171);
  cBob.moveInOtherRoom(eRooms_Omni_CorridorRight, 281, 
        eRooms_Omni_CallCentre, 781, eRooms_SpookyZone, 1006, 171, 10, 10);
  cFred.moveInOtherRoom(eRooms_Omni_CorridorRight, 281, 
        eRooms_Omni_CallCentre, 781, eRooms_SpookyZone, 1006, 171, 10, 10);
  cSally.moveInOtherRoom(eRooms_Omni_CorridorRight, 281, 
        eRooms_Omni_CallCentre, 781, eRooms_SpookyZone, 1006, 171, 10, 10);
  
}

function room_FirstLoad()
{
  setupComps();
}


function room_Load()
{
  initCompPos();
  prevRoomConditions();
  turnOnLightsLoad();
  timeToAsk = 2.0;
  Time.setSky(oSunset, oNight, oDistance);
  changePlayerLocaleOnRoomEnter();
  resumeMusicAfterCHCH(aEndlessOffice);
  findCameraPosition();
  if(characterChange)
  {
    characterChange = false;
  }
}
